wait(0.01)

--services

local DDS = game:GetService("DataStoreService")

local TPS = game:GetService("TeleportService")

local RS = game:GetService("ReplicatedStorage").SRAdminEvents

local SStorage = game:GetService("ServerStorage")

local Players = game:GetService("Players")

local TCS = game:GetService("TextChatService")

local ServerScriptService = game:GetService("ServerScriptService")

-- API's , Command and Anti Exploit Modules
local Commands = script["Commands"]

local  AEMs = script["AntiExploitModules"]

local APIs = script["API's"]

local wbhkAPI = require(APIs.WebhookAPI)

-- datastores
local BanStore = DDS:GetDataStore(game.PlaceId,"Banned_Users")

local StaffStore = DDS:GetDataStore(game.PlaceId,"Staff")

local ActiveGlobalAnnouncements = DDS:GetDataStore(game.PlaceId,"Global_Announcements")


-- chatversion & mutedplayer stuff
local chatversion = TCS.ChatVersion

-- events
local VerVent = RS.VerVent
local PosEvent = RS.PosEvent
local PltEvent = RS.PltEvent
local CLTEvent = RS.CLTEvent
local ADMEventV2 = RS.ADMEventV2
local UpdateTools = RS.UpdateTools
local DPlrBP = RS.DisplayPlrBPEvent
local DVeh = RS.DispVehEvent
local RprtEvent = RS.ReportEvent
local UpdateLogEvent = RS.UpdateLogEvent
local GetCommands = RS.GetCommands
local GetPlrRank = RS.GetPlayerRank
local ManageUI = RS.ManageUI
local GetChatTagInfo = RS.GetChatTags

-- config stuff
local config = require(script.Parent:WaitForChild("SR_Loader"):WaitForChild("Config"))
local rjcmdenabled =  config["Miscellaneous"]["RejoinCMDEnabled"]
local defaulthealth = config["Miscellaneous"]["DefaultHealth"]
local permrankchanges = config["Miscellaneous"]["PermRankChanges"]
local tools = SStorage:WaitForChild("Tools"):GetChildren()
local vehicles = SStorage.Vehicles


-- rank stuff
local customRanks = config["Custom Ranks"]
local groupStuff = config["Group"]
local groupRanks = groupStuff["Ranks"]
local trelloStuff = config["Trello Stuff"]
local trelloRanks = trelloStuff["Ranks"]

--Other UI's
local UIs = script.UIs

local warngui = UIs.WarnGui

local servmsgui = UIs.ServerMessage

local mainpanel = UIs.Panel

--framework stuff

local FlightStuff = script.FlightStuff

local PlrRanks = script.PlayerRanks

local webhookenable = config["Webhook Logging"]["WebhookEnabled"]

local webhookid = config["Webhook Logging"]["WebhookID"]

local MiscStuff = script.MiscellaneousStuff

-- Only used for tool stuff

local currtools = {}
local removetools = {}


-- Some other random variables I was too lazy to classify

local anticheat = config["Anti-Cheat"]["AntiCheatEnabled"]
local anticheatignore = config["Anti-Cheat"]["AntiCheatIgnore"]

-- Chat Command Stuff
local ChatCommandsEnabled = config["Chat Commands"]["ChatCMDSEnabled"]
local ChatCommandPrefix = config["Chat Commands"]["ChatCMDSPrefix"]




--DEVELOPER NOTE: PLEASE DO NOT TOUCH CODE THAT IS GREY. DOING SO MAY RESULT IN SEVERAL ERRORS BEING PRODUCED

ADMEventV2.OnServerEvent:Connect(function(player,opttarg,action,optreason,optextraval)
	if player and action then
		local targ = game.Players[opttarg]
		local staffrank = PlrRanks[player.Name].Value
		local targrank = PlrRanks[opttarg].Value
		
		
		if Commands:FindFirstChild(action) then
			
			local cmd = require(Commands[action])
			
			
			
			if action == "Mute" or action == "Unmute" or action == "Warn" or action == "Kick" or action == "Ban" or action == "Bring" or action == "Unban" or action == "Perm Kick" and optreason then
				cmd.ExecuteCommand(targ,player,staffrank,targrank,optreason)
			elseif action == "Shutdown" and optreason then
				cmd.ExecuteCommand(player,staffrank,optreason)
			elseif action == "Freeze" or action == "Unfreeze" or action == "Unfly" or action == "View" or action == "Kill" or action == "God" or action == "Ungod" then
				cmd.ExecuteCommand(targ,player,staffrank,targrank)
			elseif action == "Fly" or action == "Set Team"  or action == "Give Tool" or action == "Remove Tool" or action == "Set Rank" or action == "Set JumpPower" or action == "Set Walkspeed" and optextraval then
				cmd.ExecuteCommand(targ,player,staffrank,targrank,optextraval)
			elseif action == "Set Time" or action == "Announce" or action == "Spawn Vehicle"  and optextraval then
				cmd.ExecuteCommand(player,staffrank,optextraval)
			elseif action == "Staff Lock" and optextraval ~= "" and optreason ~= "" then
				cmd.ExecuteCommand(player,staffrank,optreason,optextraval)
			elseif action == "Private Message" and opttarg and optextraval ~= "" then
				cmd.ExecuteCommand(targ,player,staffrank,optextraval)
			end
		end
	end
end)

-- Chat Commands (it i s not recommended to modify this section unless you know exactly what you're doing)
game.Players.PlayerAdded:Connect(function(plr)
	plr.Chatted:Connect(function(cmd)
		if string.lower(cmd) == string.lower(ChatCommandPrefix.."rejoin") then
			TPS:Teleport(game.PlaceId, plr)
			return
		end
		if cmd and ChatCommandsEnabled == true then
			if string.find(tostring(cmd),tostring(ChatCommandPrefix),1,false) then
				cmd = string.gsub(tostring(cmd),tostring(ChatCommandPrefix),"")
				local parameters = string.split(tostring(cmd)," ")
				if #parameters <= 1 then return end 
				local action
				local actionindex
				local allcmds = Commands:GetChildren()
				local v1 = string.upper(string.sub(tostring(parameters[1]), 1, 1))..string.sub(tostring(parameters[1]), 2, -1)
				local v2 = v1 ..  " " .. string.upper(string.sub(tostring(parameters[2]), 1, 1))..string.sub(tostring(parameters[2]), 2, -1)
				for i=1,#allcmds do
					local alias = require(allcmds[i])
					local cmdloc = false
					if string.lower(v1) == string.lower(alias.ChatCMDAlias) or string.lower(v1) == string.lower(allcmds[i].Name) then
						actionindex = 2
						cmdloc = true
					elseif string.lower(v2) == string.lower(alias.ChatCMDAlias) or string.lower(v2) == string.lower(allcmds[i].Name) then
						actionindex = 3
						cmdloc = true
					end
					if cmdloc == true then
						action = allcmds[i].Name
						break
					end
				end
				local targ
				local attemptedplr = game.Players:FindFirstChild(string.gsub(tostring(parameters[actionindex])," ",""))
				if attemptedplr  then
					targ = attemptedplr
					actionindex += 1
				else
					attemptedplr = plr
					targ = plr
				end
				if attemptedplr == nil then return end
				
				if action and targ ~= "" and targ ~= nil then
					local actionreq = require(Commands[action])
					local staffrank = PlrRanks[plr.Name].Value
					local targrank = PlrRanks[targ.Name].Value
					action = string.lower(tostring(action))
					local paramlength = #parameters
					
					if actionreq.CanBeUsedInChat == false then return end
					
					if action == "mute" or action == "unmute" or action == "warn" or action == "kick" or action == "ban" or action == "bring" or action == "Unban" or action == "perm kick" then
						local optreason = ""
						for i=actionindex,paramlength do
							optreason = optreason .. parameters[i] .. " "
						end
						if optreason ~= "" and optreason ~= nil then
							actionreq.ExecuteCommand(targ,plr,staffrank,targrank,optreason)
						end
					elseif action == "shutdown" then
						local optreason = ""
						for i=actionindex,paramlength do
							optreason = optreason .. parameters[i] .. " "
						end
						if optreason ~= "" and optreason ~= nil then
							actionreq.ExecuteCommand(plr,staffrank,optreason)
						end
					elseif action == "freeze" or action == "unfreeze" or action == "unfly" or action == "view" or action == "kill" or action == "god" or action == "ungod" then
						actionreq.ExecuteCommand(targ,plr,staffrank,targrank)
					elseif action == "fly" or action == "set team"  or action == "give tool" or action == "remove tool" or action == "set rank" then
						local optextraval = ""
						for i=actionindex,paramlength do
							if i == paramlength then
								optextraval = optextraval .. parameters[i]
							else
								optextraval = optextraval .. parameters[i] .. " "
							end
						end
						if optextraval ~= "" and optextraval ~= nil then
							actionreq.ExecuteCommand(targ,plr,staffrank,targrank,optextraval)
						end
					elseif action == "set time" or action == "announce" or action == "spawn vehicle" then
						local optextraval = ""
						for i=actionindex,paramlength do
							optextraval = optextraval .. parameters[i] .. " "
						end
						if optextraval ~= "" and optextraval ~= nil then
							actionreq.ExecuteCommand(plr,staffrank,optextraval)
						end
					elseif action == "staff lock" then
						local optextraval = parameters[paramlength]
						local optreason = ""
						for i=actionindex,paramlength-1 do
							optreason = optreason .. parameters[i] .. " "
						end
						if optreason ~= nil and optreason ~= "" and optextraval ~= "" and optextraval ~= nil then
							actionreq.ExecuteCommand(plr,staffrank,optreason,optextraval)
						end
					elseif action == "private message" then
						local optextraval = ""
						for i=actionindex,paramlength do
							if i == paramlength then
								optextraval = optextraval .. parameters[i]
							else
								optextraval = optextraval .. parameters[i] .. " "
							end
						end
						if optextraval ~= "" and optextraval ~= nil then
							actionreq.ExecuteCommand(targ,plr,staffrank,optextraval)
						end
					elseif action == "set walkspeed" or action == "set jumppower" then
						local optextraval = ""
						for i=actionindex,paramlength do
							if i == paramlength then
								optextraval = optextraval .. parameters[i]
							else
								optextraval = optextraval .. parameters[i] .. " "
							end
						end
						if optextraval ~= nil and optextraval ~= "" then
							if tonumber(optextraval) then
								actionreq.ExecuteCommand(targ,plr,staffrank,targrank,optextraval)
							end
						end
					end
				end
			end
		end
	end)
end)

--Report Event

RprtEvent.OnServerEvent:Connect(function(plr,targ,reason)
	if plr and targ and reason then
		local flagged = require(script.Flagging.Flagged)
		flagged.Reported(plr,targ,reason)
	end
end)


-- Removing The UI From & Giving The UI To The Player
ManageUI.OnServerEvent:Connect(function(plr,action,targ)
	if plr and action then
		local plrgui = plr.PlayerGui
		
		if action == "delete" then
			local t = plrgui:FindFirstChild("Panel")
			if t ~= nil or t == true then
				t.Enabled = false
			end
		elseif action == "give" then
			local t = plrgui:FindFirstChild("Panel")
			if t == false or t == nil then
				local char = plr.Character or plr.CharacterAdded:Wait()
				local hum = char.Humanoid
				mainpanel:Clone().Parent = plr.PlayerGui
				hum:UnequipTools()
			else
				t.Enabled = true
			end
		end
		
	end
end)

-- Get Chat Tags For New TextChatService
GetChatTagInfo.OnServerInvoke = function(plr,targ)
	if plr and targ then
		local tagData
		local assigned = false
		local targplr = game.Players:FindFirstChild(targ)
		if targplr then
			local plrrank = PlrRanks:FindFirstChild(targplr.Name).Value
			if plrrank > 0 then
				local CustomRanks = config["Custom Ranks"]

				local Group = config["Group"]
				local GroupEnabled = Group["GroupEnabled"]
				local GroupID = Group["GroupId"]
				local GroupRanks = Group["Ranks"]

				local Trello = config["Trello Stuff"]
				local TrelloEnabled = Trello["TrelloEnabled"]
				local TrelloRanks = Trello["Ranks"]
				local TrelloBoardName = Trello["TrelloBoardName"]
				local TrelloAPI = require(script["API's"].TrelloAPI)
				
				if TrelloEnabled  and assigned == false then
					local board = TrelloAPI:GetBoardID(TrelloBoardName)
					for _,v in pairs(TrelloRanks) do
						if v["RankListName"] ~= "" then
							local list = TrelloAPI:GetLists(v["RankListName"],board)
							local cards = TrelloAPI:GetCardsInList(list)
							local assigned = false
							for _, i in pairs(cards) do
								if string.find(i.name,plr.UserId) or string.find(i.name,plr.Name) then
									if TrelloRanks[i]["TagEnabled"] == true then
										tagData = TrelloRanks[i]["StaffTag"]
									end
									assigned = true
									break
								end
							end
							if assigned then
								break
							end
						end
					end
				end

				if GroupEnabled and assigned == false then
					for _,v in pairs(GroupRanks) do
						if v["RankId"] == plr:GetRankInGroup(GroupID) then
							if v["TagEnabled"] == true then
								tagData = v["StaffTag"]
							end
							assigned = true
							break
						end
					end
				end
				
				
				if assigned == false then
					if plr.UserId == game.CreatorId then
						tagData = CustomRanks["Owner"]["StaffTag"]
						assigned = true
					else
						for _,v in pairs(CustomRanks) do
							if (table.find(v["Users"],plr.UserId) or table.find(v["Users"],tostring(plr.UserId)) or table.find(v["Users"],plr.Name)) ~= (nil and -1) then
								if v["TagEnabled"] == true then
									tagData = v["StaffTag"]
								end
								assigned = true
								break
							end
						end
					end
					
				end
	
			end
		end
		if tagData ~= nil then
			return tagData
		end
	end
end

-- Get Commands
GetCommands.OnServerInvoke = function(plr)
	if plr then
		local plrrank = PlrRanks:FindFirstChild(plr.Name).Value
		if plrrank then
			local AllCommands = script.Commands:GetChildren()
			local c = {}
			for i=1,#AllCommands do
				if AllCommands[i].Name ~= "Template" then
					local v = require(AllCommands[i])
					local n = AllCommands[i].Name
					local r = v.RankRequired
					if r <=plrrank then
						local sub = {n,v.Desc,r}
						table.insert(c,sub)
					end
				end
			end
			return c
		end
		
	end
end


-- Getting the Player Rank

GetPlrRank.OnServerInvoke = function(plr)
	if plr then
		local s = PlrRanks:FindFirstChild(plr.Name)
		if s then
			local r = PlrRanks:FindFirstChild(plr.Name).Value
			local info = {r}
			local assigned = false
			
			if plr.UserId == game.CreatorId and assigned == false and customRanks["Owner"]["TagEnabled"] then
				table.insert(info,customRanks["Owner"]["RankName"])
				assigned = true
			end
			
			if groupStuff["GroupEnabled"] and assigned == false then
				for _,v in pairs(groupRanks) do
					if v["RankValue"] == r and v["TagEnabled"] then
						table.insert(info,v["RankName"])
						assigned = true
						break
					end
				end
			end
			
			if trelloStuff["TrelloEnabled"] and assigned == false then
				for _,v in pairs(trelloRanks) do
					if v["RankValue"] == r and v["TagEnabled"] then
						table.insert(info,v["RankName"])
						assigned = true
						break
					end
				end
			end
			
			if assigned == false then
				for _,v in pairs(customRanks) do
					if v["RankValue"] == r and v["TagEnabled"] then
						table.insert(info,v["RankName"])
						assigned = true
						break
					end
				end
			end
			if assigned then
				return info
			else
				table.insert(info,"Regular / No Rank")
				return info
			end
			
		end
	end
end



--checking if values are being changed on the client without changing on the server. Anti Exploit
VerVent.OnServerEvent:Connect(function(player,val,nckval)
	if val and nckval and anticheat == true  then
		
		local char = player.Character or player.CharacterAdded:Wait()
		local hum = char.Humanoid
		local reason = nil
		local verkick = false
		local isnotinignoretable = false
		if table.find(anticheatignore,val,1) then
			isnotinignoretable = true
		end
		if isnotinignoretable == false then
			if nckval == "ReportCooldown" then
				local r = player.PlayerGui:FindFirstChild("Panel"):FindFirstChild("UIManager"):FindFirstChild("RprtInterval")
				if r ~= nil and r.Value ~= val then
					reason = "Attempted to change the cooldown value for the report function on the client"
					verkick = true
				end
			elseif nckval == "Flying" then
				local f = char.Flying
				if f.Value ~= val then
					reason = "Attempted to change the flying value on the client"
					verkick = true
				end
			elseif nckval == "Freeze" then
				local fz = char.Frozen
				if fz.Value ~= val then
					reason = "Attempted to change the freeze value on the client"
					verkick = true
				end

			elseif nckval == "AddedGui" then
				if not player.PlayerGui:FindFirstChild(val) and val ~= "TextBox" and val ~= "ProximityPrompts" then
					reason = "Attempted to add the following object: "..val.." to "..player.Name.."'s GUI on the client"
					verkick = true
				end
			elseif nckval == "AddedChar" then
				if not char:FindFirstChild(val) then
					reason = "Attempted to add the following object: "..val.." to "..player.Name.."'s character on the client"
					verkick = true
				end
			elseif nckval == "AddedBP" then
				if not player.Backpack:FindFirstChild(val) then
					reason = "Attempted to add the following object: "..val.." to "..player.Name.."'s backpack on the client"
					verkick = true
				end
			elseif nckval == "Rank" then
				local r = char.Rank
				if r ~= nil and r.Value ~= val then
					reason = "Attempted to change the rank value within the character on the client"
					verkick = true
				end
			elseif nckval == "CMDCooldown" then
				local r = player.PlayerGui:FindFirstChild("Panel"):FindFirstChild("UIManager"):FindFirstChild("CMDCooldown")
				if r ~= nil and r.Value ~= val then
					reason = "Attempted to change the command cooldown on the client"
					verkick = true
				end
			elseif nckval == "Admin Tool" then
				reason = "Attempted to obtain the Admin Tool without actually being a staff member of the following game: "..game.Name
				verkick = true
			elseif nckval == "WalkSpeed" then
				local wspeed = hum.WalkSpeed
				if val ~= wspeed then
					reason = "Attempted to change their character's walkspeed from: **"..tostring(wspeed).."** to: **"..tostring(val).."** on the client."
					verkick = true
				end
			elseif nckval == "JumpPower" then
				local jpower = hum.JumpPower
				if val ~= jpower then
					reason = "Attempted to change their character's jump-power from: **"..tostring(jpower).."** to: **"..tostring(val).."** on the client."
					verkick = true
				end
			end
			if verkick and reason then
				local AEK = require(AEMs["AntiExploitKick"])
				AEK.TriggeredAE(player,reason)
			end
		end
	end
	
end)

-- checking if player is moving while frozen. Anti Exploit
PosEvent.OnServerEvent:Connect(function(player,lastcf,currentcf)
	if player and lastcf and currentcf then
		local char  = player.Character or player.CharacterAdded:Wait()
		local frozenval = char:WaitForChild("Frozen")
		local humrootpos = char.HumanoidRootPart.CFrame
		
		if frozenval.Value == true and lastcf ~= currentcf then
			local AEK = require(AEMs["AntiExploitKick"])
			AEK.TriggeredAE(player,"Moving while frozen")
		end
	end
end)


--tools
UpdateTools.OnServerInvoke = function(player)
	for i=1,#tools do
		if not table.find(currtools,tools[i].Name) then
			table.insert(currtools,tools[i].Name)
		end
	end
	return currtools
end

--remove tools 
DPlrBP.OnServerInvoke = function(player,targ)
	if targ then
		local plr = game.Players[targ]
		local bp = plr:WaitForChild("Backpack"):GetChildren()
		table.clear(removetools)
		for i=1,#bp do
			if not table.find(removetools,bp[i].Name) then
				table.insert(removetools,bp[i].Name)
			end
		end
		return removetools
	end
end

--display vehicles

DVeh.OnServerInvoke = function(player)
	local allvehs = vehicles:GetChildren()
	local vehs = {}
	for i=1,#allvehs do
		if not table.find(vehs,allvehs[i].Name) then
			table.insert(vehs,allvehs[i].Name)
		end
	end
	return vehs
end

-- mute system for the new textchatservice
TCS.DescendantAdded:Connect(function(child)
	if child:IsA("TextSource") then
		
		if child.UserId == TargId then
			child.CanSend = false
		end
	end
end)

-- mute any current TextSources


--anti exploit module giver

Players.PlayerAdded:Connect(function(player)
	if player then
		local char = player.Character or player.CharacterAdded:Wait()
		local c = char:GetChildren()
		local x = 0
		local r6 = {
			"Head",
			"Torso",
			"HumanoidRootPart",
			"Left Arm",
			"Right Arm",
			"Left Leg",
			"Right Leg",
		}
		
		local r15 = {
			"Head",
			"LowerTorso",
			"UpperTorso",
			"HumanoidRootPart",
			"LeftLowerArm",
			"LeftUpperArm",
			"LeftHand",
			"RightLowerArm",
			"RightUpperArm",
			"RightHand",
			"LeftLowerLeg",
			"LeftUpperLeg",
			"LeftFoot",
			"RightLowerLeg",
			"RightUpperLeg",
			"RightFoot",
		}
		for i=1,#c do
			if c[i]:IsA("BasePart") then
				if table.find(r6,c[i].Name) then
					x+=1
				elseif table.find(r15,c[i].Name) then
					x +=1
				end
			end
		end
		if x == 7 then
			AEMs.CkVal:Clone().Parent = char["Right Arm"]
		elseif x == 15 then
			AEMs.CkVal:Clone().Parent = char["RightLowerArm"]
		end
	end
end)

--tp character to original pos if frozen

Players.PlayerAdded:Connect(function(player)
	
	local char = player.Character or player.CharacterAdded:Wait()
	
	char.Humanoid.Died:Connect(function()
		
		if script.FrozenUsers:FindFirstChild(player.Name) then
			player.CharacterAdded:Connect(function()
				local refrze = require(AEMs["RespawnFreeze"])
				refrze.TriggeredAE(player)
			end)
		end
	end)
	
end)



Players.PlayerRemoving:Connect(function(player)
	PlrRanks:FindFirstChild(player.Name):Destroy()
end)
